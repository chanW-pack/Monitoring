# 본사 모니터링 시스템 백업 서버 구축

---

- 이슈
    
    172.16.0.67 서버 (zabbix, grafana) 이어도 대시보드 연결 이슈 발생
    > 이슈 1. 이어도 관련 슬랙 경보 알람이 마구잡이로 발송됨
                > 이어도 본 서버 확인하니 , 서버에는 이상이 없음.
       이슈 2. 하지만, 신승회계법인 ,힌츠페터 대시보드 모두 연결 이상 x
                > 즉, 모니터링 서버 그라파나도 이상은 없는 상태,
       이슈 3. 모니터링 서버 **자빅스 mysql 이슈**
                > 프로세스 작동은 확인되나, zabbix web 접속 불가. 오류 코드는 **mysql 접속 불가**
                > mysql 접속 불가로 확인하니, mysql은 이상 없으며 **서버 디스크 용량이 full** 상태였음.
    
- 해결
    
    즉, 모니터링시, 서버에 파일이 남게되는데 서버 디스크 용량이 가득 차, 더 이상
    모니터링이 송신되지 않는 이슈였음.
    가장 오래된 파일을 수동으로 삭제하여 용량 확보하니, 모니터링 시스템 전체 정상화.
    
- 조사가 필요한 사항
    
    용량이슈로, 언젠가는 발생할 이슈였음. 해당 용량 관리의 자동화 방법을 물색해야 함
    

---

### 모니터링 서버 Zabbix, Grafana 용량 확보 방안 조사

1. 이슈 발생 시, 그 동안에 데이터는 저장되지 않음 > 예비용 grafana 서버 구축
2. 모니터링 서버 디스크 용량 확장
3. zabbix 의 경우 mysql에 데이터 저장됨. 저장 기간을 자유롭게 설정 가능하며, 백업도 지원
 s3에 백업 가능하지만, 현재 esxi 서버 디스크용량이 많기 때문에 esxi 서버에 백업용 서버 생성 고민
 = 172 서버에 백업  서버 생성 후 , NFS 로 백업 db 저장
      

### 1. 예비 Grafana 서버 구축 (Server1>ServerB 마이그레이션)

현재 `ieodo-zabbix-server(172.16.0.67)` 에 grafana가 동작 중이며, 
예비 grafana 서버로 `hinz-zabbix-server(172.16.0.4)` 구축 진행

현재 해당 서버들은 zabbix만 실행중이므로, 리소스에 여유가 있음. 모니터링 서버를 통합함으로서 유지 관리에 유용함

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled.png)

기존 프로세스로 실행되던 grafana server를 예비 모니터링 서버에서는 container 로 동작하게 구축한다.

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled%201.png)

```bash
grafana의 경우 
# config file
/etc/grafana
# DB file
/var/lib/grafana

의 데이터를 백업하면 된다.

zabbix의 경우
mysql 
zabbix.history
zabbix.history_uint
zabbix.trends
zabbix.trends_uint
table을 mysql dump로 백업 가능하다.
```

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled%202.png)

해당 데이터 디렉터리들을 tar로 압축하고 예비 모니터링 서버로 복사(scp)한다.

예비 모니터링 서버(172.16.0.4)에서는 container로 grafana를 실행하는데, docker container mount 기능을 사용하여 해당 백업 데이터를 사용하게 만든다.

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled%203.png)

마치 심볼릭 링크처럼 컨테이너에서 원하는 저장 공간만을 공유해서 데이터를 읽고 사용할 수 있는 옵션을 제공한다.

볼륨 생성 방법과 바인드 마운트 방법이 있는데, 본인은 후자의 방법으로 진행하였다.

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled%204.png)

원본 서버에서 가져온 tar 파일을 압축 해제한다.  

/etc/grafana(config file) : grafana

/var/lib/grafana(DB file) : grafanaDB

해당 디렉터리들을 마운트 포인트로 사용하여, grafana를 container로 실행시킨다.

```bash
#docker 
docker run -d -v /root/grafana:/etc/grafana -v /root/grafanaDB:/var/lib/grafana -p 3333:3000 grafana/grafana:9.2.2-ubuntu
```

-v 옵션 : -volume 옵션으로도 사용할 수 있으며,   
형식은 -v [마운트 포인트] : [컨테이너 위치] 이다.

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled%205.png)

![Untitled](%E1%84%87%E1%85%A9%E1%86%AB%E1%84%89%E1%85%A1%20%E1%84%86%E1%85%A9%E1%84%82%E1%85%B5%E1%84%90%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%87%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%E1%86%B8%20%E1%84%89%E1%85%A5%E1%84%87%E1%85%A5%20%E1%84%80%E1%85%AE%E1%84%8E%E1%85%AE%E1%86%A8%2029f9574659c34441aebdd53006294b1f/Untitled%206.png)

원본 서버와 동일한 내용의 grafana data가 그대로 구현되었다.

추가로 container로 동작하기 때문에 유지관리의 더욱 효과적이다.

---

### 2. 모니터링 서버 디스크 용량 확장

### 3. Monitoring-backup server 구축

```bash

#docker 
docker run -d -v /root/grafana:/etc/grafana -v /root/grafanaDB:/var/lib/grafana -p 3333:3000 grafana/grafana:9.2.2-ubuntu
```